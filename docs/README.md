# Мікросервіси для sentiment analysis

## Що таке мікросервіси?
<br>"Мікросервіси" - ще один новий термін на галасливих вулицях розробки ПЗ. І хоча ми зазвичай досить насторожено ставимося до всіх подібних новинок, саме цей термін визначає стиль розробки ПЗ, який ми знаходимо все більш привабливим. За останні кілька років ми бачили безліч проектів, які використовують цей стиль, і результати досі були дуже позитивними. Настільки, що більшість наших колег цей стиль стає основним стилем розробки ПЗ. На жаль, існує не так багато інформації, яка описує, чим є мікросервіси і як застосовувати їх.</br>
<br>Якщо коротко, то архітектурний стиль мікросервісів - це підхід, при якому єдиний додаток будується як набір невеликих сервісів, кожен з яких працює у своєму процесі та комунікує з іншими використовуючи легковажні механізми, як правило, HTTP. Ці послуги побудовані навколо бізнес-потреб і розгортаються незалежно з використанням повністю автоматизованого середовища. Існує абсолютний мінімум централізованого керування цими сервісами. Самі собою ці послуги можуть бути написані різними мовами і використовувати різні технології зберігання даних.</br>
<br>В даному проекті я розповім як працюють мікросервіси на прикладі застосунку, який основан на мікросервісах. Наша програма буде виконувати таку функцію: вона приймає, як вхідні дані, якесь словосполучення чи речення, після чого, використовуючи sentiment analysis, ми отримуюємо оцінку емоційного відношення автора пропозиції до якогось об'єкта.</br>

**Ось так вигрядає вікно цього застосунку**

![microservices](https://github.com/t1pUr/edu-dis-labs/blob/master/src/images/app.gif)
<br>Джерело: https://habrastorage.org/getpro/habr/post_images/674/7e1/415/6747e14151585819867c880f52fa9d21.gif

<br>З технічної точки зору програма складається з трьох мікросервісів, кожен з яких вирішує певний набір завдань:</br>

- SA-Frontend – веб-сервер Nginx, який обслуговує статичні файли React.
- SA-WebApp — веб-програма, написана на Java, яка обробляє запити від фронтенду.
- SA-Logic — програма Python, яка виконує аналіз тональності тексту.

Мікросервіси існують не в ізоляції. Вони реалізують ідею «поділу обов'язків», але їм, у своїй, необхідно взаємодіяти одне з одним.

**Наглядний приклад того як це все працює**

![microservices](https://github.com/t1pUr/edu-dis-labs/blob/master/src/images/app_work.gif)
<br>Джерело: https://habrastorage.org/getpro/habr/post_images/94b/f93/0c0/94bf930c03220c1eec6957a0f7308046.gif

<br>На схемі, показаній вище, можна побачити пронумеровані етапи роботи системи, що ілюструють потоки даних у додатку. Розберемо їх:

1. Браузер запитує сервера файл index.html (який, в свою чергу, робить завантаження пакета React-программы).
2. Користувач взаємодіє з програмою, це викликає звернення до веб-застосунку, заснованого на Spring.
3. Веб-програма перенаправляє запит на виконання аналізу тексту Python-додатку.
4. Python-додаток проводить аналіз тональності тексту та повертає результат у вигляді відповіді на запит.
5. Spring-програма відправляє відповідь React-програмі (а вона, у свою чергу, показує результат аналізу тексту користувачеві).</br>

## Запуск програми, що базується на мікросервісах, на локальному комп'ютері
<br>Одразу зазначу, що весь код знаходиться у каталогу src/code. Для того, щоб програма працювала коректно, нам потрібно запустити всі три мікросервіси. Почнемо з самого красивого - з фронтенд-додатку.</br>

**Налаштування React для локальної розробки**
<br>Сподіваюсь, що у вас вже встановлений Node.js та NPM, тому перейдемо в каталог *sa-frontend* та виконаємо команду.</br>
> npm install

<br>Завдяки виконанню цієї команди в папку node_modules будуть завантажені залежності програми React, записи про які є у файлі package.json. Після завершення завантаження залежностей у тій самій папці виконайте таку команду:</br>
> npm start

<br>Тепер програма React запущена, доступ до неї можна отримати, перейшовши в браузері за адресою **localhost:3000**. Можете щось змінити в його коді. Ефект від цих змін ви побачите в браузері. Це можливо завдяки так званій гарячій заміні модулів. Завдяки цьому фронтенд-розробка перетворюється на просте та приємне заняття.</br>

**Підготовка React-додатка до виведення у продакшн**
<br>Для справжнього використання React-програми нам потрібно перетворити його на набір статичних файлів і віддавати їх клієнтам, використовуючи веб-сервер.Для складання програми React, знову, використовуючи термінал, перейдіть до папки sa-frontend і виконайте наступну команду:</br>
>npm run build

<br>Це спричинить створення в папці проекту директорії build. У ній будуть утримуватися всі статичні файли, необхідні для роботи програми React.</br>

**Обслуговування статичних файлів засобами Nginx**
<br>Для початку потрібно встановити та запустити веб-сервер Nginx. Потім потрібно скопіювати вміст папки sa-frontend/build у папку [your_nginx_installation_dir]/html.</br>
<br>При такому підході файл index.html, що згенерований у процесі складання React-додатка, буде доступний за адресою [your_nginx_installation_dir]/html/index.html. Це файл, який за замовчуванням Nginx-сервер видає при зверненні до нього. Сервер настроєний на прослуховування порту 80, але його можна налаштувати так, як вам потрібно, відредагувавши файл [your_nginx_installation_dir]/conf/nginx.conf.

Тепер відкрийте браузер і перейдіть на адресу localhost:80. Ви побачите сторінку програми React.</br>
![microservices](https://github.com/t1pUr/edu-dis-labs/blob/master/src/images/result1.png)

## Аналіз коду фронтенд-застосунку
<br>у файлу App.js, можна побачити, що натискання на кнопку Send викликає метод analyzeSentence(). Код цього методу наведено нижче. При цьому зверніть увагу на те, що до кожного рядка, до якого є коментар виду №, є пояснення, наведене нижче коду. Так само ми розбиратимемо й інші фрагменти коду.</br>

```javascript
analyzeSentence() {
    fetch('http://localhost:8080/sentiment', {  // #1
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
                       sentence: this.textField.getValue()})// #2
    })
        .then(response => response.json())
        .then(data => this.setState(data));  // #3
}
```

<br>1. URL, яким виконується POST-запрос. Мається на увазі, що за цією адресою знаходиться програма, яка чекає на подібні запити.

2.Тіло запиту, що надсилається додатком. Ось приклад тіла запиту:</br>

```javascript
{
    sentence: "Hello world!"
}
```

3.При отриманні відповіді запит здійснюється оновлення стану компонента. Це спричиняє повторний рендеринг компонента. Якщо ми отримуємо дані (тобто JSON-об'єкт, що містить введені дані та обчислену оцінку тексту), ми виведемо компонент Polarity, оскільки будуть дотримані відповідні умови. Ось як ми описуємо компонент:

```javascript
const polarityComponent = this.state.polarity !== undefined ?
    <Polarity sentence={this.state.sentence} 
              polarity={this.state.polarity}/> :
    null;
```

Код, наче, виглядає працездатним. Але що тут не так? Якщо ви припустите, що за тією адресою, за якою програма намагається надіслати POST-запит, немає поки нічого, що може цей запит прийняти та обробити, то ви будете абсолютно праві. А саме, для обробки запитів, що надходять за адресою http://localhost:8080/sentiment, нам потрібно запустити веб-додаток, що базується на Spring. Зараз будемо з цим розбиратися.

![microservices](https://github.com/t1pUr/edu-dis-labs/blob/master/src/images/step1.png)
<br>Джерело: https://habrastorage.org/r/w1560/getpro/habr/post_images/848/f16/5a3/848f165a308f9ae73ffd3f8186b23aee.png

## Налаштування веб-застосунку на Spring
Для того щоб розгорнути Spring-додаток, вам знадобиться JDK8 та Maven та правильно налаштовані змінні середовища. Після того, як ви це встановите, ви можете продовжувати роботу над нашим проектом. Перейдіть за допомогою терміналу в папку sa-webapp і введіть наступну команду:
> mvn install

Після виконання цієї команди у папці sa-webapp буде створено директорію target. Тут буде знаходитись Java-додаток, упакований у jar-файл, представлений файлом sentiment-analysis-web-0.0.1-SNAPSHOT.jar. Для запуску Java застосунку перейдіть до папки target і запустіть програму наступною командою:
> java -jar sentiment-analysis-web-0.0.1-SNAPSHOT.jar

У ході виконання цієї команди трапиться помилка. Для того щоб приступити до її виправлення, ми можемо проаналізувати відомості про виключення даних трасування стека:
```
Error creating bean with name 'sentimentController': Injection of autowired dependencies failed; nested exception is java.lang.IllegalArgumentException: Could not resolve placeholder 'sa.logic.api.url' in value "${sa.logic.api.url}"
```
Для нас тут найважливіше – згадка про неможливість з'ясування значення sa.logic.api.url. Проаналізуємо код, де відбувається помилка.

## Аналіз коду Java-програми
Ось фрагмент коду, де відбувається помилка.
```java
@CrossOrigin(origins = "*")
@RestController
public class SentimentController {
    @Value("${sa.logic.api.url}")    // #1
    private String saLogicApiUrl;
    @PostMapping("/sentiment")
    public SentimentDto sentimentAnalysis(
        @RequestBody SentenceDto sentenceDto) 
    {
        RestTemplate restTemplate = new RestTemplate();
        return restTemplate.postForEntity(
                saLogicApiUrl + "/analyse/sentiment",    // #2
                sentenceDto, SentimentDto.class)
                .getBody();
    }
}
```

1. У S entimentControllerє поле saLogicApiUrl. Його значення задається властивістю sa.logic.api.url.
2. Рядок saLogicApiUrlконкатенується зі значенням /analyse/sentiment. Разом вони формують адресу виконання звернення до мікросервісу, що виконує аналіз тексту.

У Spring стандартним джерелом значень властивостей є файл application.properties, який можна знайти за адресою sa-webapp/src/main/resources. Але його використання - це не єдиний спосіб завдання значень властивостей. Зробити це можна і за допомогою команди наступного виду:
```
java -jar sentiment-analysis-web-0.0.1-SNAPSHOT.jar --sa.logic.api.url=WHAT.IS.THE.SA.LOGIC.API.URL
```

Значення цієї властивості має вказувати на адресу нашої програми Python.

Налаштовуючи його, ми повідомляємо веб-програмі Spring про те, куди йому потрібно звертатися для виконання запитів на аналіз тексту.

Для того, щоб не ускладнювати собі життя, вирішимо, що Python-додаток буде доступний за адресою localhost:5000і будемо намагатися про це не забути. В результаті команда для запуску Spring-програми буде виглядати так:

```
java -jar sentiment-analysis-web-0.0.1-SNAPSHOT.jar --sa.logic.api.url=http://localhost:5000
```

![microservices](https://github.com/t1pUr/edu-dis-labs/blob/master/src/images/step2.png)
<br>Джерело: https://habrastorage.org/r/w1560/getpro/habr/post_images/30d/445/815/30d44581533865907366e867c029124e.png

Тепер залишилося найголовніше, запустити програму на Python.

## Налаштування програми Python
Для того, щоб запустити програму Python, у вас повинні бути встановлені Python 3 і Pip, і потрібно, щоб були правильно налаштовані відповідні змінні середовища.

Cпочатку треба перейти до папки проекту sa-logic/saта та виконати такі команди:
```
python -m pip install -r requirements.txt
python -m textblob.download_corpora
```
Запускаємо програму
```
python sentiment_analysis.py
```
Тепер програма запущена та очікує на запит за адресою localhost:5000/

## Розбираємо код на Python
```python
from textblob import TextBlob
from flask import Flask, request, jsonify
app = Flask(__name__)                                   #1
@app.route("/analyse/sentiment", methods=['POST'])      #2
def analyse_sentiment():
    sentence = request.get_json()['sentence']           #3
    polarity = TextBlob(sentence).sentences[0].polarity #4
    return jsonify(                                     #5
        sentence=sentence,
        polarity=polarity
    )
if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)                #6
```

1. Ініціалізація об'єкту Flask.
2. Встановлення адреси для виконання POST-запитів.
3. Вилучення властивості sentenceз тіла запиту.
4. Ініціалізація анонімного об'єкта TextBlobі отримання значення polarityдля першого запиту пропозиції, що надійшло в тілі (у нашому випадку це — єдина пропозиція, що передається на аналіз).
5. Повернення відповіді, в тілі якої міститься текст пропозиції та обчислений для нього показник polarity.
6. Запуск Flask-програми, яка буде доступна за адресою 0.0.0.0:5000(звернутися до неї можна і використовуючи конструкцію виду localhost:5000).

Тепер мікросервіси, з яких складається програма, запущені. Вони налаштовані на взаємодію одне з одним. Ось як виглядає схема програми на фінальному етапі роботи.

![microservices](https://github.com/t1pUr/edu-dis-labs/blob/master/src/images/ready.png)
<br>Джерело: https://habrastorage.org/r/w1560/getpro/habr/post_images/75a/fcc/135/75afcc1352ed237efaf0a2280c2df295.png
